<?php
/**
 * WEBHOOK DEFINITIVO - Sistema WhatsApp completo para wamundo.com
 * Integra funcionalidad completa del negocio: autenticaci√≥n, b√∫squedas IMAP, permisos
 */

// Cargar configuraci√≥n y servicios principales
require_once __DIR__ . '/../config/path_constants.php';
require_once PROJECT_ROOT . '/vendor/autoload.php';

use Shared\ConfigService;
use Shared\DatabaseManager;
use WhatsappBot\Services\WhatsappAuth;
use WhatsappBot\Services\WhatsappQuery;
use WhatsappBot\Services\LogService;

// Headers de respuesta
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST');
header('Access-Control-Allow-Headers: Content-Type');

// Inicializar servicios principales
$logger = new LogService();
$logger->info("=== WEBHOOK PRODUCTION INICIADO ===");

/**
 * Funci√≥n de env√≠o de mensajes via wamundo.com
 */
function sendWhatsAppResponse($recipient, $message) {
    global $logger;
    
    $config = ConfigService::getInstance();
    $apiSecret = $config->get('WHATSAPP_NEW_SEND_SECRET', '');
    $accountId = $config->get('WHATSAPP_NEW_ACCOUNT_ID', '');
    
    if (empty($apiSecret) || empty($accountId)) {
        $logger->error("API credentials not configured for sending");
        return ['success' => false, 'error' => 'API not configured'];
    }
    
    $url = "https://wamundo.com/api/send/whatsapp";
    
    $data = [
        "secret" => $apiSecret,
        "account" => $accountId,
        "recipient" => $recipient,
        "type" => "text",
        "message" => $message,
        "priority" => 1
    ];
    
    $logger->debug("Sending WhatsApp message", [
        'recipient' => $recipient,
        'message_length' => strlen($message)
    ]);
    
    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $data,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_CONNECTTIMEOUT => 10,
        CURLOPT_SSL_VERIFYPEER => false
    ]);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $curlError = curl_error($ch);
    curl_close($ch);
    
    if ($response === false || !empty($curlError)) {
        $logger->error("cURL error sending message", ['error' => $curlError]);
        return ['success' => false, 'error' => 'Connection error'];
    }
    
    if ($httpCode === 200) {
        $responseData = json_decode($response, true);
        if ($responseData && $responseData['status'] === 200) {
            $logger->info("Message sent successfully", [
                'recipient' => $recipient,
                'message_id' => $responseData['data']['messageId'] ?? 'N/A'
            ]);
            return ['success' => true, 'data' => $responseData];
        }
    }
    
    $logger->error("Failed to send message", [
        'http_code' => $httpCode,
        'response' => $response
    ]);
    return ['success' => false, 'error' => "HTTP $httpCode"];
}

try {
    // Verificar m√©todo POST
    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        http_response_code(405);
        echo json_encode(['error' => 'Method not allowed']);
        exit;
    }

    // Verificar configuraci√≥n de base de datos
    try {
        $db = DatabaseManager::getInstance()->getConnection();
    } catch (Exception $e) {
        $logger->error("Database connection failed: " . $e->getMessage());
        http_response_code(500);
        echo json_encode(['error' => 'Database unavailable']);
        exit;
    }

    // Leer y validar webhook data
    $request = $_POST;
    $logger->debug("Webhook request received", ['request' => $request]);

    // Verificar webhook secret
    $config = ConfigService::getInstance();
    $webhookSecret = $config->get('WHATSAPP_NEW_WEBHOOK_SECRET', '');
    $receivedSecret = $request["secret"] ?? '';
    
    if (!empty($webhookSecret) && !hash_equals($webhookSecret, $receivedSecret)) {
        $logger->error("Invalid webhook secret");
        http_response_code(401);
        echo json_encode(['error' => 'Unauthorized']);
        exit;
    }

    // Validar estructura del payload
    $payloadType = $request["type"] ?? '';
    $payloadData = $request["data"] ?? [];

    if ($payloadType !== 'whatsapp' || empty($payloadData)) {
        $logger->error("Invalid payload structure", [
            'type' => $payloadType,
            'has_data' => !empty($payloadData)
        ]);
        http_response_code(400);
        echo json_encode(['error' => 'Invalid payload']);
        exit;
    }

    // Extraer datos del mensaje
    $messageId = $payloadData['id'] ?? 0;
    $messageText = trim($payloadData['message'] ?? '');
    $attachment = $payloadData['attachment'] ?? '';
    $timestamp = $payloadData['timestamp'] ?? time();
    
    // Determinar remitente (priorizar phone sobre wid)
    $senderPhone = $payloadData['phone'] ?? $payloadData['wid'] ?? '';
    $cleanSender = preg_replace('/[^+0-9]/', '', $senderPhone);

    $logger->info("Processing WhatsApp message", [
        'message_id' => $messageId,
        'sender' => $cleanSender,
        'message' => substr($messageText, 0, 50) . '...',
        'has_attachment' => !empty($attachment)
    ]);

    if (empty($messageText) || empty($cleanSender)) {
        $logger->error("Missing required fields", [
            'has_message' => !empty($messageText),
            'has_sender' => !empty($cleanSender)
        ]);
        http_response_code(400);
        echo json_encode(['error' => 'Missing required fields']);
        exit;
    }

    // Inicializar servicios de WhatsApp
    $auth = new WhatsappAuth();
    $auth->cleanupExpiredData();
    $query = new WhatsappQuery($auth);

    $botResponse = '';
    $shouldRespond = false;

    // ========== PROCESAR COMANDOS DEL NEGOCIO ==========

    // Comando /login usuario contrase√±a
    if (preg_match('/^\/login\s+(\S+)\s+(\S+)$/i', $messageText, $matches)) {
        $username = $matches[1];
        $password = $matches[2];
        
        $logger->info("Login attempt", [
            'sender' => $cleanSender,
            'username' => $username
        ]);
        
        try {
            $user = $auth->loginWithCredentials($cleanSender, $username, $password);
            
            if ($user) {
                $botResponse = "üîê *Sesi√≥n iniciada correctamente*\n\n" .
                              "üë§ Usuario: *" . $user['username'] . "*\n" .
                              "üÜî ID: " . $user['id'] . "\n" .
                              "üì± WhatsApp vinculado exitosamente\n\n" .
                              "‚úÖ Ya puedes usar todos los comandos:\n" .
                              "‚Ä¢ `/buscar email plataforma`\n" .
                              "‚Ä¢ `/codigo id`\n" .
                              "‚Ä¢ `/stats`\n\n" .
                              "_Sesi√≥n v√°lida por " . (WhatsappAuth::SESSION_LIFETIME / 3600) . " horas_";
                $shouldRespond = true;
                
                $logger->info("Login successful", [
                    'user_id' => $user['id'],
                    'username' => $user['username'],
                    'sender' => $cleanSender
                ]);
            } else {
                $botResponse = "‚ùå *Credenciales incorrectas*\n\n" .
                              "Usuario o contrase√±a inv√°lidos.\n\n" .
                              "üìù Formato correcto:\n" .
                              "`/login tu_usuario tu_contrase√±a`\n\n" .
                              "üí° Contacta al administrador si tienes problemas.";
                $shouldRespond = true;
                
                $logger->warning("Login failed", [
                    'username' => $username,
                    'sender' => $cleanSender
                ]);
            }
        } catch (Exception $e) {
            $logger->error("Login error: " . $e->getMessage());
            $botResponse = "üîß *Error del sistema*\n\n" .
                          "Hubo un problema con la autenticaci√≥n.\n" .
                          "Int√©ntalo m√°s tarde o contacta al administrador.";
            $shouldRespond = true;
        }
    }
    
    // Comando /buscar email plataforma
    elseif (preg_match('/^\/buscar\s+(\S+@\S+\.\S+)\s+(\S+)$/i', $messageText, $matches)) {
        $email = strtolower($matches[1]);
        $platform = $matches[2];
        
        $logger->info("Search request", [
            'sender' => $cleanSender,
            'email' => $email,
            'platform' => $platform
        ]);
        
        try {
            // Primero verificar autenticaci√≥n
            $user = $auth->authenticateUser($cleanSender);
            if (!$user) {
                $botResponse = "üîí *Acceso denegado*\n\n" .
                              "Debes iniciar sesi√≥n primero.\n\n" .
                              "Usa: `/login tu_usuario tu_contrase√±a`";
                $shouldRespond = true;
            } else {
                // Mensaje de procesamiento
                $processingMsg = "üîç *Buscando c√≥digos...*\n\n" .
                               "üìß Email: `" . $email . "`\n" .
                               "üéØ Plataforma: *" . $platform . "*\n\n" .
                               "‚è≥ Consultando servidores IMAP...\n" .
                               "_Esto puede tardar unos segundos_";
                
                sendWhatsAppResponse($cleanSender, $processingMsg);
                
                // Ejecutar b√∫squeda real
                $searchResult = $query->processSearchRequest(
                    (int)$cleanSender, // Usar tel√©fono como ID temporal
                    (int)$cleanSender,
                    $email,
                    $platform
                );
                
                if (isset($searchResult['found']) && $searchResult['found']) {
                    $codes = $searchResult['emails'] ?? [];
                    $botResponse = "‚úÖ *C√≥digos encontrados*\n\n" .
                                  "üìß Email: `" . $email . "`\n" .
                                  "üéØ Plataforma: *" . $platform . "*\n" .
                                  "üìä Resultados: " . count($codes) . "\n\n";
                    
                    foreach (array_slice($codes, 0, 5) as $i => $code) {
                        $botResponse .= "üîê **C√≥digo " . ($i + 1) . ":**\n";
                        $botResponse .= "`" . $code['content'] . "`\n";
                        if (isset($code['id'])) {
                            $botResponse .= "üÜî ID: " . $code['id'] . "\n";
                        }
                        $botResponse .= "üìÖ " . $code['date'] . "\n\n";
                    }
                    
                    if (count($codes) > 5) {
                        $botResponse .= "... y " . (count($codes) - 5) . " c√≥digos m√°s\n\n";
                    }
                    
                    $botResponse .= "_Usa `/codigo id` para obtener un c√≥digo espec√≠fico_";
                } else {
                    $error = $searchResult['error'] ?? 'No se encontraron c√≥digos';
                    $botResponse = "üòî *Sin resultados*\n\n" .
                                  "üìß Email: `" . $email . "`\n" .
                                  "üéØ Plataforma: *" . $platform . "*\n\n" .
                                  "‚ùå " . $error . "\n\n" .
                                  "üí° Verifica:\n" .
                                  "‚Ä¢ Email escrito correctamente\n" .
                                  "‚Ä¢ Plataforma v√°lida\n" .
                                  "‚Ä¢ Permisos de acceso";
                }
                
                $shouldRespond = true;
            }
        } catch (Exception $e) {
            $logger->error("Search error: " . $e->getMessage());
            $botResponse = "üîß *Error en la b√∫squeda*\n\n" .
                          "Hubo un problema consultando los servidores.\n" .
                          "Int√©ntalo m√°s tarde o contacta al administrador.";
            $shouldRespond = true;
        }
    }
    
    // Comando /codigo id
    elseif (preg_match('/^\/codigo\s+(\d+)$/i', $messageText, $matches)) {
        $codeId = (int)$matches[1];
        
        $logger->info("Code request", [
            'sender' => $cleanSender,
            'code_id' => $codeId
        ]);
        
        try {
            $user = $auth->authenticateUser($cleanSender);
            if (!$user) {
                $botResponse = "üîí *Acceso denegado*\n\n" .
                              "Debes iniciar sesi√≥n primero.\n\n" .
                              "Usa: `/login tu_usuario tu_contrase√±a`";
            } else {
                $codeResult = $query->getCodeById($cleanSender, $codeId);
                
                if (isset($codeResult['found']) && $codeResult['found']) {
                    $code = $codeResult['content'];
                    $botResponse = "‚úÖ *C√≥digo encontrado*\n\n" .
                                  "üÜî ID: " . $codeId . "\n" .
                                  "üîê C√≥digo: `" . $code['content'] . "`\n" .
                                  "üìÖ Fecha: " . $code['date'] . "\n" .
                                  "üìß Email: " . $code['email'] . "\n" .
                                  "üéØ Plataforma: " . $code['platform'];
                } else {
                    $error = $codeResult['error'] ?? 'C√≥digo no encontrado';
                    $botResponse = "‚ùå *C√≥digo no disponible*\n\n" .
                                  "üÜî ID solicitado: " . $codeId . "\n\n" .
                                  $error;
                }
            }
            
            $shouldRespond = true;
        } catch (Exception $e) {
            $logger->error("Code retrieval error: " . $e->getMessage());
            $botResponse = "üîß *Error obteniendo c√≥digo*\n\n" .
                          "Hubo un problema accediendo al c√≥digo.\n" .
                          "Verifica el ID e int√©ntalo m√°s tarde.";
            $shouldRespond = true;
        }
    }
    
    // Comando /stats
    elseif (preg_match('/^\/stats$/i', $messageText)) {
        try {
            $user = $auth->authenticateUser($cleanSender);
            if (!$user) {
                $botResponse = "üîí *Acceso denegado*\n\n" .
                              "Debes iniciar sesi√≥n primero.";
            } else {
                $stats = $query->getStats();
                $botResponse = "üìä *Estad√≠sticas del Sistema*\n\n" .
                              "üë• Usuarios activos: " . $stats['active_users'] . "\n" .
                              "üîç B√∫squedas hoy: " . $stats['searches_today'] . "\n" .
                              "üìà Total b√∫squedas: " . $stats['total_searches'] . "\n" .
                              "üîó Plataforma: wamundo.com\n" .
                              "‚ö° Estado: Completamente operativo\n\n" .
                              "üÜî Tu ID: " . $user['id'] . "\n" .
                              "üë§ Usuario: " . $user['username'];
            }
            
            $shouldRespond = true;
        } catch (Exception $e) {
            $logger->error("Stats error: " . $e->getMessage());
            $botResponse = "Error obteniendo estad√≠sticas.";
            $shouldRespond = true;
        }
    }
    
    // Comando /ayuda
    elseif (preg_match('/^\/ayuda$/i', $messageText)) {
        $user = $auth->authenticateUser($cleanSender);
        
        $botResponse = "ü§ñ *Bot de C√≥digos - Gu√≠a Completa*\n\n";
        
        if (!$user) {
            $botResponse .= "üîí **Primero debes autenticarte:**\n" .
                           "`/login tu_usuario tu_contrase√±a`\n\n";
        }
        
        $botResponse .= "üìã **Comandos disponibles:**\n" .
                       "‚Ä¢ `/login usuario contrase√±a` - Iniciar sesi√≥n\n" .
                       "‚Ä¢ `/buscar email plataforma` - Buscar c√≥digos\n" .
                       "‚Ä¢ `/codigo id` - Obtener c√≥digo espec√≠fico\n" .
                       "‚Ä¢ `/stats` - Ver estad√≠sticas\n" .
                       "‚Ä¢ `/ayuda` - Esta ayuda\n\n" .
                       "üìù **Ejemplos de uso:**\n" .
                       "‚Ä¢ `/buscar juan@gmail.com Netflix`\n" .
                       "‚Ä¢ `/codigo 12345`\n\n" .
                       "üîó Plataforma: wamundo.com\n" .
                       "_Sistema completamente funcional_";
        
        $shouldRespond = true;
    }
    
    // Comando no reconocido
    elseif (preg_match('/^\//', $messageText)) {
        $botResponse = "‚ùì *Comando no reconocido*\n\n" .
                      "Comando: `" . substr($messageText, 0, 20) . "`\n\n" .
                      "Usa `/ayuda` para ver todos los comandos disponibles.";
        $shouldRespond = true;
    }

    // ========== ENVIAR RESPUESTA ==========
    
    $responseSuccess = false;
    if ($shouldRespond && !empty($botResponse) && !empty($cleanSender)) {
        $sendResult = sendWhatsAppResponse($cleanSender, $botResponse);
        $responseSuccess = $sendResult['success'];
        
        if (!$responseSuccess) {
            $logger->error("Failed to send response", [
                'error' => $sendResult['error'] ?? 'Unknown error',
                'recipient' => $cleanSender
            ]);
        }
    }

    // Respuesta al webhook
    $logger->info("Webhook processed", [
        'message_id' => $messageId,
        'command' => substr($messageText, 0, 20),
        'response_sent' => $responseSuccess,
        'should_respond' => $shouldRespond
    ]);
    
    http_response_code(200);
    echo json_encode([
        'success' => true,
        'message' => 'Webhook processed successfully',
        'message_id' => $messageId,
        'response_sent' => $responseSuccess,
        'timestamp' => time()
    ], JSON_UNESCAPED_UNICODE);

} catch (Exception $e) {
    $logger->error("Critical webhook error: " . $e->getMessage(), [
        'file' => $e->getFile(),
        'line' => $e->getLine()
    ]);
    
    http_response_code(500);
    echo json_encode([
        'error' => 'Internal server error',
        'message' => $e->getMessage()
    ]);
}

$logger->info("=== WEBHOOK PRODUCTION FINALIZADO ===");
?>
